{% extends "base.html" %}
{% block content %}

{% set can_edit = current_user.is_admin or current_user.can_manage() %}
{% set is_admin = current_user.is_admin %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 fw-bold mb-1">Προμήθεια #{{ procurement.id }}</h1>
    <div class="text-muted small">
      Όλα τα στοιχεία παραμένουν διαθέσιμα για επεξεργασία μετά την αποθήκευση.
    </div>
  </div>
  <a href="{{ url_for('procurements.inbox_procurements') }}" class="btn btn-outline-secondary btn-sm">
    &larr; Επιστροφή
  </a>
</div>

<div class="card glass-card shadow-sm border-0 mb-3">
  <div class="card-body">
    <h2 class="h6 fw-bold mb-3">Βασικά στοιχεία</h2>

    <form method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- ROW 1: BASIC INFO + SUMMARY + ANALYSIS -->
      <div class="row g-3">
        <div class="col-12 col-lg-8">

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Υπηρεσία</label>
            <div class="col-8">
              {% if is_admin %}
                <select name="service_unit_id" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                  <option value="">(επιλέξτε)</option>
                  {% for su in service_units %}
                    <option value="{{ su.id }}" {% if procurement.service_unit_id == su.id %}selected{% endif %}>
                      {{ su.short_name or su.description }}
                    </option>
                  {% endfor %}
                </select>
              {% else %}
                <input class="form-control form-control-sm" disabled
                       value="{{ procurement.service_unit.short_name if procurement.service_unit else '' }}">
              {% endif %}
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Α/Α</label>
            <div class="col-8">
              <input name="serial_no" class="form-control form-control-sm"
                     value="{{ procurement.serial_no or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <!-- NEW: Φόρος Εισοδήματος επιλογή -->
          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Τύπος Προμήθειας</label>
            <div class="col-8">
              <select name="income_tax_rule_id" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                <option value="">(—)</option>
                {% for r in income_tax_rules %}
                  <option value="{{ r.id }}" {% if procurement.income_tax_rule_id == r.id %}selected{% endif %}>
                    {{ r.description }} ({{ r.rate_percent }}% > {{ r.threshold_amount }}€)
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">
                Η επιλογή χρησιμοποιείται στον υπολογισμό ΦΕ.
              </div>
            </div>
          </div>

          <!-- NEW: Επιτροπή (ανά υπηρεσία) -->
          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Επιτροπή Προμηθειών</label>
            <div class="col-8">
              <select name="committee_id" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                <option value="">(—)</option>
                {% for c in committees %}
                  <option value="{{ c.id }}" {% if procurement.committee_id == c.id %}selected{% endif %}>
                    {{ c.description }}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Εμφανίζονται μόνο οι ενεργές επιτροπές της υπηρεσίας.</div>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Σύντομη Περιγραφή *</label>
            <div class="col-8">
              <input name="description" class="form-control form-control-sm" required
                     value="{{ procurement.description or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΑΛΕ</label>
            <div class="col-8">
              <input name="ale" class="form-control form-control-sm"
                     value="{{ procurement.ale or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Κατανομή</label>
            <div class="col-8">
              <select name="allocation" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                <option value="">(—)</option>
                {% for v in allocation_options %}
                  <option value="{{ v }}" {% if procurement.allocation == v %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Τριμηνιαία</label>
            <div class="col-8">
              <select name="quarterly" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                <option value="">(—)</option>
                {% for v in quarterly_options %}
                  <option value="{{ v }}" {% if procurement.quarterly == v %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Κατάσταση</label>
            <div class="col-8">
              <select name="status" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                <option value="">(—)</option>
                {% for v in status_options %}
                  <option value="{{ v }}" {% if procurement.status == v %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Στάδιο</label>
            <div class="col-8">
              <select name="stage" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                <option value="">(—)</option>
                {% for v in stage_options %}
                  <option value="{{ v }}" {% if procurement.stage == v %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Χειριστής (Προσωπικό)</label>
            <div class="col-8">
              <select name="handler_personnel_id" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                <option value="">(—)</option>
                {% for p in handler_candidates %}
                  <option value="{{ p.id }}" {% if procurement.handler_personnel_id == p.id %}selected{% endif %}>
                    {{ p.full_name() }}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Μόνο ενεργό προσωπικό της υπηρεσίας.</div>
            </div>
          </div>

        </div>

        <div class="col-12 col-lg-4">
          <div class="card bg-light border-0 h-100">
            <div class="card-body py-3 small">

              <!-- Centered Winner -->
              <div class="text-center mb-2">
                <div class="fw-bold">Μειοδότης</div>
                <div class="mt-1">{{ procurement.winner_supplier_display or '—' }}</div>
              </div>

              <hr class="my-2">

              <!-- Centered "Ποσά Προέγκρισης" -->
              <div class="text-center mb-2">
                <div class="fw-bold">Ποσά Προέγκρισης</div>
              </div>

              <!-- Amounts aligned: label left / value right -->
              <div class="d-flex justify-content-between">
                <span>Σύνολο</span>
                <span class="fw-semibold">
                  {% if procurement.sum_total %}{{ "{:,.2f}".format(procurement.sum_total) }} €{% else %}—{% endif %}
                </span>
              </div>
              <div class="d-flex justify-content-between">
                <span>ΦΠΑ</span>
                <span class="fw-semibold">
                  {% if procurement.vat_amount %}{{ "{:,.2f}".format(procurement.vat_amount) }} €{% else %}—{% endif %}
                </span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="fw-bold">Γενικό Σύνολο</span>
                <span class="fw-bold">
                  {% if procurement.grand_total %}{{ "{:,.2f}".format(procurement.grand_total) }} €{% else %}—{% endif %}
                </span>
              </div>

              <hr class="my-2">

              <!-- ΑΝΑΛΥΣΗ ΔΑΠΑΝΗΣ -->
              <div class="fw-bold mb-2">ΑΝΑΛΥΣΗ ΔΑΠΑΝΗΣ</div>

              <div class="d-flex justify-content-between mb-1">
                <span>Σύνολο</span>
                <span class="fw-semibold">{{ "{:,.2f}".format(analysis["sum_total"]) }} €</span>
              </div>

              {% set pw = analysis["public_withholdings"] %}
              {% if pw["total_amount"] and pw["total_amount"] != 0 %}
                <div class="mt-2">
                  <div class="d-flex justify-content-between fw-semibold">
                    <span>Κρατήσεις υπέρ δημοσίου ({{ pw["total_percent"] }}%)</span>
                    <span>{{ "{:,.2f}".format(pw["total_amount"]) }} €</span>
                  </div>

                  <div class="mt-2">
                    {% for item in pw["items"] %}
                      <div class="d-flex justify-content-between">
                        <span>{{ item["label"] }} ({{ item["percent"] }}%)</span>
                        <span>{{ "{:,.2f}".format(item["amount"]) }} €</span>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {% set it = analysis["income_tax"] %}
              {% if it["amount"] and it["amount"] != 0 %}
                <div class="mt-2">
                  <div class="d-flex justify-content-between fw-semibold">
                    <span>Φόρος Εισοδήματος ({{ it["rate_percent"] }}%)</span>
                    <span>{{ "{:,.2f}".format(it["amount"]) }} €</span>
                  </div>
                  <div class="text-muted" style="font-size: 12px;">
                    Υπολογισμός: [Σύνολο - Κρατήσεις] × {{ it["rate_percent"] }}%
                  </div>
                </div>
              {% endif %}

              {% if analysis["vat_amount"] and analysis["vat_amount"] != 0 %}
                <div class="mt-2">
                  <div class="d-flex justify-content-between fw-semibold">
                    <span>ΦΠΑ ({{ analysis["vat_percent"] }}%)</span>
                    <span>{{ "{:,.2f}".format(analysis["vat_amount"]) }} €</span>
                  </div>
                </div>
              {% endif %}

              <div class="mt-2 pt-2 border-top d-flex justify-content-between fw-bold">
                <span>Τελικό Πληρωτέο Ποσό</span>
                <span>{{ "{:,.2f}".format(analysis["payable_total"]) }} €</span>
              </div>

            </div>
          </div>
        </div>
      </div>

      <hr class="my-3">

      <!-- ROW 2: HOP FIELDS + NOTES -->
      <div class="row g-3">
        <div class="col-12 col-lg-8">

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΗΩΠ Δέσμευσης</label>
            <div class="col-8">
              <input name="hop_commitment" class="form-control form-control-sm"
                     value="{{ procurement.hop_commitment or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΗΩΠ Προωθητικού Δέσμευσης 1</label>
            <div class="col-8">
              <input name="hop_forward1_commitment" class="form-control form-control-sm"
                     value="{{ procurement.hop_forward1_commitment or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΗΩΠ Προωθητικού Δέσμευσης 2</label>
            <div class="col-8">
              <input name="hop_forward2_commitment" class="form-control form-control-sm"
                     value="{{ procurement.hop_forward2_commitment or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>
          
          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΗΩΠ Έγκρισης Δέσμευσης</label>
            <div class="col-8">
              <input name="hop_approval_commitment" class="form-control form-control-sm"
                     value="{{ procurement.hop_approval_commitment or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΗΩΠ Προέγκρισης</label>
            <div class="col-8">
              <input name="hop_preapproval" class="form-control form-control-sm"
                     value="{{ procurement.hop_preapproval or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΗΩΠ Προωθητικού 1 (Προέγκρισης)</label>
            <div class="col-8">
              <input name="hop_forward1_preapproval" class="form-control form-control-sm"
                     value="{{ procurement.hop_forward1_preapproval or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΗΩΠ Προωθητικού 2 (Προέγκρισης)</label>
            <div class="col-8">
              <input name="hop_forward2_preapproval" class="form-control form-control-sm"
                     value="{{ procurement.hop_forward2_preapproval or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΗΩΠ Έγκρισης</label>
            <div class="col-8">
              <input name="hop_approval" class="form-control form-control-sm"
                     value="{{ procurement.hop_approval or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΑΑΥ</label>
            <div class="col-8">
              <input name="aay" class="form-control form-control-sm"
                     value="{{ procurement.aay or '' }}" {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Μεταφορά σε Εκκρεμείς Δαπάνες</label>
            <div class="col-8">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="send_to_expenses" id="send_to_expenses"
                       {% if procurement.send_to_expenses %}checked{% endif %}
                       {% if not can_edit %}disabled{% endif %}>
                <label class="form-check-label" for="send_to_expenses">
                  Ναι (λειτουργεί μόνο αν υπάρχει ΗΩΠ Έγκρισης)
                </label>
              </div>
            </div>
          </div>

          <!-- NEW: Κρατήσεις επιλογή (πάνω από ΦΠΑ) -->
          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">Κρατήσεις (Περιγραφή)</label>
            <div class="col-8">
              <select name="withholding_profile_id" class="form-select form-select-sm" {% if not can_edit %}disabled{% endif %}>
                <option value="">(—)</option>
                {% for p in withholding_profiles %}
                  <option value="{{ p.id }}" {% if procurement.withholding_profile_id == p.id %}selected{% endif %}>
                    {{ p.description }}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Η επιλογή επηρεάζει την Ανάλυση Δαπάνης.</div>
            </div>
          </div>

          <div class="mb-2 row align-items-center">
            <label class="col-4 col-form-label col-form-label-sm">ΦΠΑ</label>
            <div class="col-8">
              <input name="vat_rate" class="form-control form-control-sm" placeholder="24 ή 0.24"
                     value="{{ procurement.vat_rate if procurement.vat_rate is not none else '' }}"
                     {% if not can_edit %}disabled{% endif %}>
            </div>
          </div>

        </div>

        <div class="col-12 col-lg-4">
          <div class="card bg-light border-0 h-100">
            <div class="card-body py-3 small">
              <div class="fw-bold mb-2">Παρατηρήσεις Προμήθειας</div>
              <textarea
                name="procurement_notes"
                class="form-control"
                rows="14"
                {% if not can_edit %}disabled{% endif %}
                placeholder="Παρατηρήσεις χειριστή για την προμήθεια (εσωτερικές σημειώσεις)."
              >{{ procurement.procurement_notes or '' }}</textarea>
              <div class="form-text mt-2">
                Εσωτερικό πεδίο. Δεν επηρεάζει τα ποσά/υπολογισμούς.
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if can_edit %}
        <div class="mt-3">
          <button class="btn btn-primary">Αποθήκευση</button>
        </div>
      {% endif %}
    </form>
  </div>
</div>

<!-- SUPPLIERS -->
<div class="card glass-card shadow-sm border-0 mb-3">
  <div class="card-body">
    <h2 class="h6 fw-bold mb-3">Προμηθευτές</h2>

    {% if can_edit %}
      <form class="row g-2 mb-3" method="post"
            action="{{ url_for('procurements.add_procurement_supplier', procurement_id=procurement.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="col-12 col-md-4">
          <select name="supplier_id" class="form-select" required>
            <option value="">(επιλέξτε)</option>
            {% for s in suppliers %}
              <option value="{{ s.id }}">{{ s.afm }} - {{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-2">
          <input type="number" step="0.01" name="offered_amount" class="form-control" placeholder="Ποσό προσφοράς">
        </div>

        <div class="col-12 col-md-2">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="is_winner" id="new_is_winner">
            <label class="form-check-label" for="new_is_winner">Μειοδότης</label>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <textarea name="notes" class="form-control" rows="2"
                    placeholder="Παρατηρήσεις (όροι, διευκρινίσεις, σχόλια)"></textarea>
        </div>

        <div class="col-12">
          <button class="btn btn-outline-primary w-100">Προσθήκη</button>
        </div>
      </form>
    {% endif %}

    {% if procurement.supplies_links %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Προμηθευτής</th>
              <th>Προσφορά</th>
              <th>Μειοδότης</th>
              <th>Παρατηρήσεις</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for link in procurement.supplies_links %}
              <tr>
                <td class="small">{{ link.supplier.afm }} - {{ link.supplier.name }}</td>
                <td class="small">
                  {% if link.offered_amount is not none %}
                    {{ "{:,.2f}".format(link.offered_amount) }} €
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="small">
                  {% if link.is_winner %}
                    <span class="badge bg-success">ΝΑΙ</span>
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="small text-break" style="max-width: 320px;">{{ link.notes or '—' }}</td>
                <td class="text-end">
                  {% if can_edit %}
                    <form method="post"
                          action="{{ url_for('procurements.delete_procurement_supplier',
                            procurement_id=procurement.id, link_id=link.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-outline-danger">Διαγραφή</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="small text-muted">Δεν υπάρχουν καταχωρημένοι προμηθευτές.</div>
    {% endif %}
  </div>
</div>

<!-- MATERIALS -->
<div class="card glass-card shadow-sm border-0">
  <div class="card-body">
    <h2 class="h6 fw-bold mb-3">Υλικά / Υπηρεσίες</h2>

    {% if can_edit %}
      <form class="row g-2 mb-3" method="post"
            action="{{ url_for('procurements.add_material_line', procurement_id=procurement.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="col-12 col-md-4">
          <input name="description" class="form-control" placeholder="Περιγραφή γραμμής" required>
        </div>
        <div class="col-6 col-md-2">
          <input name="cpv" class="form-control" placeholder="CPV">
        </div>
        <div class="col-6 col-md-2">
          <input name="nsn" class="form-control" placeholder="NSN">
        </div>
        <div class="col-6 col-md-2">
          <input name="unit" class="form-control" placeholder="Μονάδα">
        </div>
        <div class="col-6 col-md-1">
          <input type="number" step="0.01" name="quantity" class="form-control" placeholder="Ποσότητα">
        </div>
        <div class="col-6 col-md-1">
          <input type="number" step="0.01" name="unit_price" class="form-control" placeholder="Τιμή">
        </div>

        <div class="col-12">
          <button class="btn btn-outline-primary w-100">Προσθήκη</button>
        </div>
      </form>
    {% endif %}

    {% if procurement.materials %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Περιγραφή</th>
              <th>CPV</th>
              <th>NSN</th>
              <th>Μονάδα</th>
              <th class="text-end">Ποσότητα</th>
              <th class="text-end">Τιμή</th>
              <th class="text-end">Σύνολο</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for line in procurement.materials %}
              <tr>
                <td class="small">{{ line.description }}</td>
                <td class="small">{{ line.cpv or '—' }}</td>
                <td class="small">{{ line.nsn or '—' }}</td>
                <td class="small">{{ line.unit or '—' }}</td>
                <td class="small text-end">{{ line.quantity }}</td>
                <td class="small text-end">{{ line.unit_price }}</td>
                <td class="small text-end">{{ "{:,.2f}".format(line.total_pre_vat) }} €</td>
                <td class="text-end">
                  {% if can_edit %}
                    <form method="post"
                          action="{{ url_for('procurements.delete_material_line',
                            procurement_id=procurement.id, line_id=line.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-outline-danger">Διαγραφή</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="small text-muted">Δεν υπάρχουν γραμμές υλικών/υπηρεσιών.</div>
    {% endif %}
  </div>
</div>

{% endblock %}